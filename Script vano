-- =========================================================================
-- ||                              VANO-HUB                               ||
-- =========================================================================

-- Инициализация Compkiller
local Compkiller = loadstring(game:HttpGet("https://raw.githubusercontent.com/4lpaca-pin/CompKiller/refs/heads/main/src/source.luau"))();
local Notifier = Compkiller.newNotify();

-- Сервисы
local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer

-- ====================
-- || ГЛОБАЛЬНЫЕ НАСТРОЙКИ ФУНКЦИЙ
-- ====================
local InfiniteJumpEnabled = false
local SpeedEnabled = false 
local OriginalWalkSpeed = 16 -- Будет обновлено
local HealthBarEnabled = false -- Для ESP

-- ESP Переменные
local espConnections = {}
local espRun = nil
local Holder = nil

-- TP Переменные
local CurrentTarget = nil
local CurrentTweenSpeed = 5 -- Значение по умолчанию: 50 / 10 = 5 секунд

-- ====================
-- || ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
-- ====================

local function getHumanoid(player)
	return player and player.Character and player.Character:FindFirstChildOfClass('Humanoid')
end

local function getHRP(player)
	return player and player.Character and player.Character:FindFirstChild("HumanoidRootPart")
end

-- Обновление оригинальной скорости 
task.spawn(function()
	local Humanoid = getHumanoid(LocalPlayer)
	if Humanoid then
		OriginalWalkSpeed = Humanoid.WalkSpeed
	end
end)

-- Infinite Jump (ИСПРАВЛЕНО)
UserInputService.JumpRequest:Connect(function()
	if InfiniteJumpEnabled then
		local Character = LocalPlayer.Character
		local Humanoid = getHumanoid(LocalPlayer)
		
		if Humanoid and Character and Character.PrimaryPart then
			Humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
			-- Принудительный прыжок
			Character.PrimaryPart.AssemblyLinearVelocity = Character.PrimaryPart.CFrame.UpVector * Humanoid.JumpPower
		end
	end
end)

-- =========================================================================
-- ||                                 GUI ЛОГИКА
-- =========================================================================

Compkiller:Loader("rbxassetid://72788619889737" , 2.5).yield();

local Window = Compkiller.new({
	Name = "VANO-HUB",
	Keybind = "LeftAlt",
	Logo = "rbxassetid://72788619889737",
	Scale = Compkiller.Scale.Window,
	TextSize = 15,
});

Notifier.new({
	Title = "Welcome",
	Content = "Welcome rshome",
	Duration = 10,
	Icon = "rbxassetid://72788619889737"
});

-- Вотермарка
local Watermark = Window:Watermark();
Watermark:AddText({ Icon = "user", Text = "RShome" });
Watermark:AddText({ Icon = "clock", Text = Compkiller:GetDate() });

local Time = Watermark:AddText({ Icon = "timer", Text = "TIME" });
task.spawn(function()
	while true do task.wait(1)
		Time:SetText(Compkiller:GetTimeNow());
	end
end)
Watermark:AddText({ Icon = "server", Text = Compkiller.Version });

Window:DrawCategory({ Name = "Example" });

local NormalTab = Window:DrawTab({
	Name = "Main",
	Icon = "sword",
	EnableScrolling = true
});

local NormalSection = NormalTab:DrawSection({
	Name = "Section (Left)",
	Position = 'left'	
});

-- 1. Infinite Jump
NormalSection:AddToggle({
	Name = "Infinite Jump",
	Default = false,
	Callback = function(v)
		InfiniteJumpEnabled = v
	end,
});

local SpeedSlider
-- 2. Speed 
NormalSection:AddToggle({
	Name = "Speed",
	Default = false,
	Callback = function(v)
		SpeedEnabled = v
		
		local Humanoid = getHumanoid(LocalPlayer)
		
		if Humanoid then
			-- Возвращаем OriginalWalkSpeed при выключении
			local targetSpeed = v and SpeedSlider:GetValue() or OriginalWalkSpeed 
			sethiddenproperty(Humanoid, "WalkSpeed", targetSpeed)
		end
	end,
});

SpeedSlider = NormalSection:AddSlider({
	Name = "WalkSpeed Value",
	Min = 16,
	Max = 300,
	Default = 50, 
	Step = 1,
	Unit = "WalkSpeed",
	Callback = function(v)
		if SpeedEnabled then
			local Humanoid = getHumanoid(LocalPlayer)
			
			if Humanoid then
				sethiddenproperty(Humanoid, "WalkSpeed", v)
			end
		end
	end
});

local NormalSectionRight = NormalTab:DrawSection({
	Name = "Visual",
	Position = 'right'
});

-- ====================
-- || ФУНКЦИИ ESP 
-- ====================

local function UnloadCharacter(v)
	local vHolder = Holder:FindFirstChild(v.Name)
	if vHolder then
		vHolder:ClearAllChildren()
	end
end

local function highlightEsp(target, color)
	local char = target.Character
	if char then
		local hrp = getHRP(target)
		if hrp then
			local highlight = char:FindFirstChild("VANO_Highlight") or Instance.new("Highlight")
			if not highlight.Parent then
				highlight.RobloxLocked = true
				highlight.Name = "VANO_Highlight"
				highlight.Adornee = char
				highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
				highlight.Parent = char
			end
			highlight.FillColor = color
		end
	end
end

local function LoadCharacter(v, BoxTemplate, NameTagTemplate, HealthTagTemplate)
	repeat task.wait() until v.Character and getHumanoid(v) and getHRP(v)
	local Humanoid = getHumanoid(v)
	if not Humanoid then return UnloadCharacter(v) end
	
	local vHolder = Holder:FindFirstChild(v.Name) or Instance.new("Folder", Holder)
	vHolder.Name = v.Name
	vHolder:ClearAllChildren()
	
	local char = v.Character
	
	local b = BoxTemplate:Clone()
	b.Name = v.Name .. "Box"
	b.Adornee = char
	b.Parent = vHolder
	
	local t = NameTagTemplate:Clone()
	t.Name = v.Name .. "NameTag"
	t.Enabled = true
	t.Parent = vHolder
	t.Adornee = char:WaitForChild("Head", 5)
	if not t.Adornee then
		return UnloadCharacter(v)
	end
	
	t.Tag.Text = v.Name
	b.Color3 = v.TeamColor.Color
	t.Tag.TextColor3 = v.TeamColor.Color

	-- СОЗДАНИЕ МЕТКИ ЗДОРОВЬЯ
	local HealthTag = HealthTagTemplate:Clone()
	HealthTag.Name = v.Name .. "HealthTag"
	HealthTag.Enabled = HealthBarEnabled 
	HealthTag.Parent = vHolder
	HealthTag.Adornee = t.Adornee
	local HealthText = HealthTag:FindFirstChild("HealthText")
	
	local Update = nil
	local function UpdateNameTag()
		if not char or not getHumanoid(v) then
			if espConnections[v.Name] then espConnections[v.Name]:Disconnect() end
			return UnloadCharacter(v)
		end
		
		-- ЛОГИКА ОБНОВЛЕНИЯ ЗДОРОВЬЯ
		local currentHealth = math.ceil(Humanoid.Health)
		local maxHealth = Humanoid.MaxHealth

		if HealthText then
			HealthText.Text = "HP: " .. currentHealth
			
			-- Изменение цвета в зависимости от здоровья
			if currentHealth < maxHealth * 0.25 then
				HealthText.TextColor3 = Color3.fromRGB(255, 0, 0)
			elseif currentHealth < maxHealth * 0.5 then
				HealthText.TextColor3 = Color3.fromRGB(255, 255, 0) 
			else
				HealthText.TextColor3 = Color3.fromRGB(0, 255, 0)
			end
		end
		
		Humanoid.DisplayDistanceType = Enum.HumanoidDisplayDistanceType.None
	end
	
	Update = Humanoid.Changed:Connect(UpdateNameTag)
	if espConnections[v.Name] then espConnections[v.Name]:Disconnect() end
	espConnections[v.Name] = Update
	UpdateNameTag()
end

local function LoadPlayer(p, BoxTemplate, NameTagTemplate, HealthTagTemplate)
	local vHolder = Holder:FindFirstChild(p.Name) or Instance.new("Folder", Holder)
	vHolder.Name = p.Name

	espConnections[p.Name .. "CharAdded"] = p.CharacterAdded:Connect(function() pcall(LoadCharacter, p, BoxTemplate, NameTagTemplate, HealthTagTemplate) end)
	espConnections[p.Name .. "CharRemoving"] = p.CharacterRemoving:Connect(function() pcall(UnloadCharacter, p) end)
	
	-- Добавлена логика обновления ESP при смене команды
	espConnections[p.Name .. "TeamChanged"] = p.Changed:Connect(function(prop)
		if prop == "TeamColor" then
			UnloadCharacter(p)
			task.wait()
			LoadCharacter(p, BoxTemplate, NameTagTemplate, HealthTagTemplate)
		end
	end)
	
	LoadCharacter(p, BoxTemplate, NameTagTemplate, HealthTagTemplate)
end

local function UnloadPlayer(p)
	UnloadCharacter(p)
	local vHolder = Holder:FindFirstChild(p.Name)
	if vHolder then
		vHolder:Destroy()
	end
	for k, conn in pairs(espConnections) do
		if k:match(p.Name) then
			conn:Disconnect()
			espConnections[k] = nil
		end
	end
end

-- 3. Toggle ESP
NormalSectionRight:AddToggle({
	Name = "ESP",
	Default = false,
	Callback = function(v)
		if v then
			_G.FriendColor = Color3.fromRGB(0, 0, 255)
			_G.EnemyColor = Color3.fromRGB(255, 0, 0)
			_G.UseTeamColor = true

			Holder = Instance.new("Folder")
			Holder.Name = "VANO_ESP_Holder"
			Holder.Parent = game.CoreGui
			
			-- Шаблоны (Templates)
			local BoxTemplate = Instance.new("BoxHandleAdornment")
			BoxTemplate.Name = "nilBox"
			BoxTemplate.Size = Vector3.new(1, 2, 1)
			BoxTemplate.Color3 = Color3.new(100 / 255, 100 / 255, 100 / 255)
			BoxTemplate.Transparency = 0.7
			BoxTemplate.ZIndex = 0
			BoxTemplate.AlwaysOnTop = false
			BoxTemplate.Visible = false

			local NameTagTemplate = Instance.new("BillboardGui")
			NameTagTemplate.Name = "nilNameTag"
			NameTagTemplate.Enabled = false
			NameTagTemplate.Size = UDim2.new(0, 200, 0, 50)
			NameTagTemplate.AlwaysOnTop = true
			NameTagTemplate.StudsOffset = Vector3.new(0, 1.8, 0)
			local Tag = Instance.new("TextLabel", NameTagTemplate)
			Tag.Name = "Tag"
			Tag.BackgroundTransparency = 1
			Tag.Position = UDim2.new(0, -50, 0, 0)
			Tag.Size = UDim2.new(0, 300, 0, 20)
			Tag.TextSize = 15
			Tag.TextColor3 = Color3.new(100 / 255, 100 / 255, 100 / 255)
			Tag.TextStrokeColor3 = Color3.new(0 / 255, 0 / 255, 0 / 255)
			Tag.TextStrokeTransparency = 0.4
			Tag.Text = "nil"
			Tag.Font = Enum.Font.SourceSansBold
			Tag.TextScaled = false

			local HealthTagTemplate = Instance.new("BillboardGui")
			HealthTagTemplate.Name = "nilHealthTag"
			HealthTagTemplate.Enabled = false
			HealthTagTemplate.Size = UDim2.new(0, 100, 0, 20)
			HealthTagTemplate.AlwaysOnTop = true
			HealthTagTemplate.StudsOffset = Vector3.new(0, 2.3, 0) 
			local HealthTextTemplate = Instance.new("TextLabel", HealthTagTemplate)
			HealthTextTemplate.Name = "HealthText"
			HealthTextTemplate.BackgroundTransparency = 1
			HealthTextTemplate.Size = UDim2.new(1, 0, 1, 0)
			HealthTextTemplate.TextSize = 14
			HealthTextTemplate.TextColor3 = Color3.fromRGB(0, 255, 0)
			HealthTextTemplate.TextStrokeTransparency = 0.5
			HealthTextTemplate.Text = "HP: 100"
			HealthTextTemplate.Font = Enum.Font.SourceSansBold
			
			-- Загрузка существующих игроков
			for _, p in Players:GetPlayers() do
				if p ~= LocalPlayer then
					task.spawn(function() pcall(LoadPlayer, p, BoxTemplate, NameTagTemplate, HealthTagTemplate) end)
				end
			end

			-- Подключение событий
			espConnections["PlayerAdded"] = Players.PlayerAdded:Connect(function(p)
				if p ~= LocalPlayer then
					pcall(LoadPlayer, p, BoxTemplate, NameTagTemplate, HealthTagTemplate)
				end
			end)
			
			espConnections["PlayerRemoving"] = Players.PlayerRemoving:Connect(UnloadPlayer)
			
			LocalPlayer.NameDisplayDistance = 0

			-- Цикл обновления Highlight ESP (уменьшен wait для снижения нагрузки)
			espRun = task.spawn(function()
				while task.wait(0.5) and v do 
					for _, p in Players:GetPlayers() do
						if p ~= LocalPlayer then
							local color = _G.UseTeamColor and p.TeamColor.Color or ((LocalPlayer.TeamColor == p.TeamColor) and _G.FriendColor or _G.EnemyColor)
							highlightEsp(p, color)
						end
					end
				end
			end)
			
		else
			-- Очистка
			if espRun then
				task.cancel(espRun)
				espRun = nil
			end
			
			for _, conn in pairs(espConnections) do
				conn:Disconnect()
			end
			espConnections = {}
			
			if Holder then
				Holder:Destroy()
				Holder = nil
			end

			for _, obj in ipairs(game.Workspace:GetDescendants()) do
				if obj.Name == "VANO_Highlight" and obj:IsA("Highlight") then
					obj:Destroy()
				end
			end
		end
	end,
});

-- 4. Health Bar Toggle
NormalSectionRight:AddToggle({
	Name = "Health Bar",
	Default = false,
	Callback = function(v)
		HealthBarEnabled = v
		
		-- Обновляем видимость HealthTag для всех существующих игроков
		for _, p in Players:GetPlayers() do
			if p ~= LocalPlayer and p.Character then
				local vHolder = Holder and Holder:FindFirstChild(p.Name)
				if vHolder then
					local HealthTag = vHolder:FindFirstChild(p.Name .. "HealthTag")
					if HealthTag and HealthTag:IsA("BillboardGui") then
						HealthTag.Enabled = v
					end
				end
			end
		end
	end,
});


-- =========================================================================
-- ||                              GENERAL TAB (TP)
-- =========================================================================

local SingleTab = Window:DrawTab({
	Name = "General Tab",
	Icon = "fire",
	Type = "Single"
});

local GeneralSection = SingleTab:DrawSection({
	Name = "TP Player",
	Position = 'left'
});

local PlayerListDropdown = nil

-- Функция обновления списка игроков
local function UpdatePlayers()
	local playerNames = {}
	for _, player in Players:GetPlayers() do
		if player ~= LocalPlayer then
			table.insert(playerNames, player.Name)
		end
	end
	
	if #playerNames == 0 then
		table.insert(playerNames, "No players found")
	end
	
	if PlayerListDropdown then
		PlayerListDropdown:SetValues(playerNames)
		CurrentTarget = playerNames[1]
	end
	
	return playerNames
end

-- 5. TP Tween Speed (Секунды)
GeneralSection:AddSlider({
	Name = "TP Tween Speed (Seconds)", 
	Min = 10,
	Max = 100,
	Default = 50, 
	Step = 10,
	Unit = "Seconds",
	Callback = function(v)
		-- ЛОГИКА: v / 10 = 1-10 секунд
		CurrentTweenSpeed = v / 10
	end
});

PlayerListDropdown = GeneralSection:AddDropdown({
	Name = "Select Player",
	Default = "No players found",
	Values = UpdatePlayers(),
	Callback = function(selectedName)
		CurrentTarget = selectedName
	end,
});

-- 6. Teleport to Player
GeneralSection:AddButton({
	Name = "Teleport to Player",
	Callback = function()
		if not CurrentTarget or CurrentTarget == "No players found" then
			Notifier.new({
				Title = "Teleport Error",
				Content = "No valid player selected.",
				Duration = 5,
				Icon = "error"
			});
			return
		end

		local targetPlayer = Players:FindFirstChild(CurrentTarget)
		local hrp = getHRP(LocalPlayer)
		
		if targetPlayer and targetPlayer.Character and hrp then
			local targetHRP = getHRP(targetPlayer)
            if not targetHRP then
                Notifier.new({
                    Title = "Teleport Error",
                    Content = "Target's character is not fully loaded.",
                    Duration = 5,
                    Icon = "error"
                });
                return
            end

			local targetPosition = targetHRP.CFrame
			
			local tweenInfo = TweenInfo.new(
				CurrentTweenSpeed, -- Используем время в секундах
				Enum.EasingStyle.Linear,
				Enum.EasingDirection.Out,
				0,
				false,
				0
			)
			
			local properties = {CFrame = targetPosition * CFrame.new(0, 3, 0)} -- Смещение вверх на 3
			local tween = TweenService:Create(hrp, tweenInfo, properties)
			
			tween:Play()
			
			Notifier.new({
				Title = "Teleport Success",
				Content = "Teleported to " .. CurrentTarget .. " in " .. string.format("%.1f", CurrentTweenSpeed) .. "s",
				Duration = 3,
				Icon = "rbxassetid://72788619889737"
			});
		else
			Notifier.new({
				Title = "Teleport Error",
				Content = "Target player or character not found.",
				Duration = 5,
				Icon = "error"
			});
		end
	end,
});

GeneralSection:AddButton({
	Name = "Update Player List",
	Callback = function()
		UpdatePlayers()
		Notifier.new({
			Title = "Update Complete",
			Content = "Player list has been updated.",
			Duration = 3,
			Icon = "refresh"
		});
	end,
});

-- =========================================================================
-- ||                           ДОПОЛНИТЕЛЬНЫЕ ВКЛАДКИ
-- =========================================================================

local ContainerTab = Window:DrawContainerTab({
	Name = "Extract Tabs",
	Icon = "contact",
});

local ExtractTab = ContainerTab:DrawTab({
	Name = "Tab 1",
	Type = "Double"
});

local SingleExtractTab = ContainerTab:DrawTab({
	Name = "Tab 2",
	Type = "Single",
	EnableScrolling = true,
});


Window:DrawCategory({
	Name = "Misc"
});

local SettingTab = Window:DrawTab({
	Icon = "settings-3",
	Name = "Settings",
	Type = "Single",
	EnableScrolling = true
});

local ThemeTab = Window:DrawTab({
	Icon = "paintbrush",
	Name = "Themes",
	Type = "Single"
});

-- =========================================================================
-- ||                              НАСТРОЙКИ UI
-- =========================================================================

local Settings = SettingTab:DrawSection({
	Name = "UI Settings",
});

Settings:AddToggle({
	Name = "Alway Show Frame",
	Default = false,
	Callback = function(v)
		Window.AlwayShowTab = v;
	end,
});

-- COLOR PICKERS (Очищенный блок)
local colorPickers = {
    {"Highlight", Compkiller.Colors.Highlight, "Highlight"},
    {"Toggle Color", Compkiller.Colors.Toggle, "Toggle"},
    {"Drop Color", Compkiller.Colors.DropColor, "DropColor"},
    {"Risky", Compkiller.Colors.Risky, "Risky"},
    {"Mouse Enter", Compkiller.Colors.MouseEnter, "MouseEnter"},
    {"Block Color", Compkiller.Colors.BlockColor, "BlockColor"},
    {"Background Color", Compkiller.Colors.BGDBColor, "BGDBColor"},
    {"Block Background Color", Compkiller.Colors.BlockBackground, "BlockBackground"},
    {"Stroke Color", Compkiller.Colors.StrokeColor, "StrokeColor"},
    {"High Stroke Color", Compkiller.Colors.HighStrokeColor, "HighStrokeColor"},
    {"Switch Color", Compkiller.Colors.SwitchColor, "SwitchColor"},
    {"Line Color", Compkiller.Colors.LineColor, "LineColor"},
}

for _, data in ipairs(colorPickers) do
    local name, defaultColor, propName = unpack(data)
    Settings:AddColorPicker({
        Name = name,
        Default = defaultColor,
        Callback = function(v)
            Compkiller.Colors[propName] = v;
            Compkiller:RefreshCurrentColor();
        end,
    });
end


Settings:AddButton({
	Name = "Get Theme",
	Callback = function()
		print(Compkiller:GetTheme())
		
		Notifier.new({
			Title = "Notification",
			Content = "Copied Them Color to your clipboard",
			Duration = 5,
			Icon = "rbxassetid://72788619889737"
		});
	end,
});

ThemeTab:DrawSection({
	Name = "UI Themes"
}):AddDropdown({
	Name = "Select Theme",
	Default = "Default",
	Values = {
		"Default",
		"Dark Green",
		"Dark Blue",
		"Purple Rose",
		"Skeet"
	},
	Callback = function(v)
		Compkiller:SetTheme(v)
	end,
})
